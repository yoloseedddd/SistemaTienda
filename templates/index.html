<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistema Tienda Masiva</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="text-center mb-4">üõí Panel de Control - Tienda Masiva</h1>
    <div class="d-flex justify-content-center gap-3 mb-4">
        <a href="/logout" class="btn btn-danger">üö™ Cerrar Sesi√≥n</a>
        <a href="/admin/productos" class="btn btn-warning">üì¶ Gestionar Inventario</a>

        <a href="/envios" class="btn btn-outline-success">‚úàÔ∏è Env√≠os Internacionales</a>
        <a href="/perfil" class="btn btn-outline-dark">üë§ Mi Perfil</a>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Usuarios Totales</h5>
                    <p class="card-text display-4">{{ t_users }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">√ìrdenes Realizadas</h5>
                    <p class="card-text display-4">{{ t_orders }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-dark text-white">‚ö° Nueva Compra R√°pida</div>
        <div class="card-body">
            <form action="/comprar" method="POST" class="row g-3" onsubmit="this.querySelector('button[type=submit]').disabled = true;">
                {% if csrf_token is defined %}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% endif %}
                <div class="col-md-4">
                    <label for="id_usuario" class="form-label visually-hidden">Usuario</label>
                    <select id="id_usuario" name="id_usuario" class="form-select" required>
                        <option value="" selected disabled>Seleccionar Cliente...</option>
                        {% for user in users %}
                            <option value="{{ user.id }}">{{ user.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label for="id_producto" class="form-label visually-hidden">Producto</label>
                    <select id="id_producto" name="id_producto" class="form-select" required>
                        <option value="" selected disabled>Seleccionar Producto...</option>
                        {% for prod in products %}
                            <option value="{{ prod.id }}">{{ prod.nombre }} (Stock: {{ prod.stock }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="cantidad" class="form-label visually-hidden">Cantidad</label>
                    <input id="cantidad" type="number" name="cantidad" class="form-control" placeholder="Cant." required min="1" aria-label="Cantidad" step="1">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Vender</button>
                </div>
            </form>
            
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <div role="alert" aria-live="polite" class="alert alert-info mt-3">{{ messages[0] }}</div>
                {% endif %}
            {% endwith %}
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    üë• Usuarios del Sistema
                </div>
                <div class="card-body">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Rol</th>
                                <th class="text-danger">Contrase√±a (Privado)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in users %}
                            <tr>
                                <td>{{ u.id }}</td>
                                <td>{{ u.nombre }}</td>
                                <td>
                                    {% if u.rol == 'admin' %} <span class="badge bg-primary">Jefe</span>
                                    {% else %} <span class="badge bg-secondary">Cliente</span> {% endif %}
                                </td>
                                <td class="text-muted font-monospace">{{ u.password }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <h3>üìã √öltimas Ventas Registradas</h3>
    <div class="table-responsive">
    <table class="table table-striped table-hover bg-white shadow-sm">
        <caption class="visually-hidden">Listado de las √∫ltimas ventas registradas</caption>
        <thead class="table-dark">
            <tr>
                <th scope="col">Orden #</th>
                <th scope="col">Fecha</th>
                <th scope="col">Cliente</th>
                <th scope="col">Producto</th>
                <th scope="col">Total</th>
            </tr>
        </thead>
        <tbody>
    {% if ventas %}
    {% for venta in ventas %}
    <tr>
        <td>
            <a href="/recibo/{{ venta.id }}" class="text-decoration-none fw-bold text-primary" title="Ver Boleta">
                #{{ venta.id }} üìÑ
            </a>
        </td>
        <td>{{ venta.fecha_bonita }}</td>
        <td>{{ venta.cliente }}</td>
        <td class="text-truncate" style="max-width:220px;" title="{{ venta.lista_productos }}">{{ venta.lista_productos }}</td>
        <td>S/ {{ "{:,.2f}".format(venta.total) }}</td>
    </tr>
    {% endfor %}
    {% else %}
    <tr>
        <td colspan="5" class="text-center py-3">No hay ventas registradas</td>
    </tr>
    {% endif %}
</tbody>
    </table>
    </div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5>üèÜ Top Productos (Tabla)</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Foto</th>
                            <th>Producto</th>
                            <th>Ventas (S/)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prod in top_products %}
                        <tr class="align-middle"> <td>
                                {% if prod.imagen_url %}
                                    <img src="{{ prod.imagen_url }}" alt="producto" style="width: 50px; height: 50px; object-fit: contain;">
                                {% else %}
                                    <span>üì∑</span>
                                {% endif %}
                            </td>
                            
                            <td>{{ prod.nombre }}</td>
                            
                            <td class="fw-bold text-success">S/ {{ "{:,.2f}".format(prod.ingresos_generados) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5>üìä Estad√≠stica Visual</h5>
            </div>
            <div class="card-body">
                <canvas id="miGrafico"></canvas>
            </div>
        </div>
    </div>
</div>

</div>

<script src="{{ url_for('static', filename='js/app.js') }}" defer></script>

<script>
    // 1. Preparamos los datos que vienen de Python (Flask)
    // Usamos un truco para convertir la lista de Jinja a un Array de Javascript
    const nombres = [
        {% for prod in top_products %}
            "{{ prod.nombre }}", 
        {% endfor %}
    ];

    const dineros = [
        {% for prod in top_products %}
            {{ prod.ingresos_generados }}, 
        {% endfor %}
    ];

    // 2. Dibujamos el Gr√°fico
    const ctx = document.getElementById('miGrafico');

    new Chart(ctx, {
        type: 'bar', // Tipo de gr√°fico: 'bar' (barras), 'pie' (pastel), 'line' (l√≠nea)
        data: {
            labels: nombres, // Los nombres de abajo
            datasets: [{
                label: 'Ingresos en Soles (S/)',
                data: dineros, // Los n√∫meros de las barras
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
</body>
</html>